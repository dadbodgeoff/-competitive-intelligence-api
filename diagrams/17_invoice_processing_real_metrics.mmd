```mermaid
%%{init: {'theme':'dark', 'themeVariables': { 'primaryColor':'#10b981','primaryTextColor':'#fff','primaryBorderColor':'#059669','lineColor':'#6366f1','secondaryColor':'#3b82f6','tertiaryColor':'#8b5cf6'}}}%%
sequenceDiagram
    participant U as ðŸ‘¤ User
    participant F as ðŸŽ¨ Frontend
    participant API as âš¡ FastAPI
    participant AI as ðŸ¤– Gemini 2.5 Flash
    participant DB as ðŸ’¾ PostgreSQL
    participant S3 as â˜ï¸ Supabase Storage
    
    Note over U,S3: Real Invoice Upload - Actual Metrics
    
    U->>F: Upload PDF Invoice
    F->>API: POST /api/invoices/upload
    Note right of API: ðŸ”’ Auth + Malware Scan
    API->>S3: Store PDF File
    S3-->>API: File URL (secure signed)
    
    API->>AI: Stream Parse Request
    Note right of AI: Gemini 2.5 Flash<br/>3,534 tokens<br/>$0.000623 cost
    
    loop Real-time SSE Streaming
        AI-->>API: Parsing Progress...
        API-->>F: SSE: Live Updates
        F-->>U: âš¡ Real-time UI
    end
    
    AI->>API: âœ… Parsed Data (64s)
    Note right of API: 15 line items extracted<br/>High confidence
    
    API->>API: Post-Processing
    Note right of API: Validation<br/>Category detection<br/>Price verification
    
    U->>F: Review & Confirm
    F->>API: POST /api/invoices/save
    Note right of API: ðŸ”’ HTTPOnly Cookie Auth
    
    API->>DB: Save Invoice (723ms)
    Note right of DB: Transaction:<br/>1 invoice header<br/>15 line items<br/>Price tracking
    
    DB-->>API: âœ… Saved
    API->>DB: Fuzzy Match Items
    Note right of DB: Levenshtein distance<br/>Link to inventory
    
    API-->>F: âœ… Complete (723ms)
    F-->>U: ðŸŽ‰ Invoice Processed
    
    Note over U,S3: Total: ~65s (64s AI + 1s DB)
```
