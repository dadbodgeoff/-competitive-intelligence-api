graph TB
    subgraph "Client Layer"
        Browser[Browser]
        DevTools[React DevTools]
    end

    subgraph "Security Layer - Browser"
        CSP[CSP Headers<br/>script-src 'self'<br/>style-src 'self' fonts.googleapis.com]
        HSTS[HSTS<br/>Force HTTPS]
        XFrame[X-Frame-Options: DENY<br/>Clickjacking Protection]
        XContent[X-Content-Type-Options<br/>MIME Sniffing Protection]
        SameSite[SameSite=Lax Cookies<br/>CSRF Protection]
    end

    subgraph "Frontend - React/Vite"
        Pages[Pages<br/>Dashboard, Analysis, Invoices, Menu]
        Components[Components<br/>Forms, Tables, Charts]
        AuthStore[Auth Store<br/>Zustand - No localStorage]
        APIClient[API Client<br/>Axios + withCredentials]
        Monitoring[Monitoring<br/>Sentry optional<br/>PostHog optional]
    end

    subgraph "Network Layer"
        CORS[CORS Middleware<br/>localhost:3000, 5173]
        HTTPS[HTTPS/TLS<br/>Production Only]
    end

    subgraph "API Gateway - FastAPI"
        MainApp[main.py<br/>FastAPI App]
        
        subgraph "Middleware Stack"
            SecHeaders[SecurityHeadersMiddleware<br/>CSP, HSTS, X-Frame]
            CORSMid[CORSMiddleware]
            ReqLog[Request Logging<br/>Sanitizes Auth Headers]
            GlobalEx[Global Exception Handler<br/>ErrorSanitizer]
        end
        
        HealthCheck[Health Endpoints<br/>/health, /api/v1/health]
        CSPReport[CSP Violation Reporter<br/>/api/csp-report]
    end

    subgraph "Authentication Layer"
        AuthRoutes[Auth Routes<br/>/api/v1/auth/*]
        AuthMid[get_current_user<br/>JWT from HTTPOnly Cookie]
        JWTValidation[JWT Validation<br/>HS256 Algorithm]
        SupabaseAuth[Supabase Auth<br/>User Management]
    end

    subgraph "API Routes Layer"
        subgraph "Analysis Module"
            TierAnalysis[Tier Analysis<br/>@rate_limit]
            StreamAnalysis[Streaming Analysis<br/>SSE]
            AnalysisOrch[Analysis Orchestrator]
        end
        
        subgraph "Invoice Module"
            InvoiceUpload[Invoice Upload<br/>@rate_limit]
            InvoiceParse[Invoice Parse<br/>SSE Stream]
            InvoiceManage[Invoice Management]
            InvoiceProcess[Invoice Processing]
        end
        
        subgraph "Menu Module"
            MenuUpload[Menu Upload<br/>@rate_limit]
            MenuParse[Menu Parse<br/>SSE Stream]
            MenuManage[Menu Management]
            MenuRecipes[Menu Recipes]
            MenuCompare[Menu Comparison<br/>@rate_limit]
        end
        
        subgraph "Other Routes"
            Subscription[Subscription<br/>Tier Management]
            PriceAnalytics[Price Analytics]
            UserPrefs[User Preferences]
        end
    end

    subgraph "Rate Limiting Layer"
        RateLimitMid[Rate Limiting Middleware]
        Redis[(Redis Cache<br/>Rate Limit Counters<br/>Session Data)]
    end

    subgraph "Service Layer"
        subgraph "File Processing"
            FileValidator[File Validator<br/>10MB limit, PDF/Image only]
            MalwareScanner[Malware Scanner<br/>ClamAV Integration]
            DuplicateDetector[Duplicate Detector<br/>File Hash Check]
        end
        
        subgraph "LLM Services"
            FreeTierLLM[Free Tier LLM<br/>Basic Analysis]
            EnhancedLLM[Enhanced LLM<br/>Premium Analysis]
            PremiumLLM[Premium LLM<br/>Full Features]
            MenuParserLLM[Menu Parser<br/>Gemini Vision]
            InvoiceParserLLM[Invoice Parser<br/>Gemini Vision]
        end
        
        subgraph "Data Services"
            FuzzyMatcher[Fuzzy Matcher<br/>Levenshtein + Jellyfish]
            UnitConverter[Unit Converter<br/>Standardization]
            PriceAnalytics[Price Analytics Service]
            VendorMapper[Vendor Item Mapper]
        end
        
        subgraph "Storage Services"
            InvoiceStorage[Invoice Storage<br/>Supabase bucket: invoices]
            MenuStorage[Menu Storage<br/>Supabase bucket: menus]
            AnalysisStorage[Analysis Storage<br/>Enhanced + Evidence]
            MenuCompStorage[Menu Comparison Storage]
        end
        
        subgraph "Security Services"
            ErrorSanitizer[Error Sanitizer<br/>Prod/Dev Aware]
            OwnershipValidator[Ownership Validator<br/>User Data Access]
        end
        
        subgraph "Monitoring Services"
            InvoiceMonitor[Invoice Monitoring<br/>Session Tracking]
            PerfProfiler[Performance Profiler<br/>Timing Analysis]
            EventBus[Event Bus<br/>Async Processing]
        end
    end

    subgraph "External APIs - Backend Only"
        GoogleGemini[Google Gemini API<br/>LLM Processing]
        GooglePlaces[Google Places API<br/>Competitor Discovery]
        SerpAPI[SerpAPI<br/>Premium Reviews]
        Outscraper[Outscraper<br/>Review Fetching]
    end

    subgraph "Database Layer - Supabase"
        SupabaseDB[(Supabase PostgreSQL)]
        
        subgraph "Core Tables"
            Users[users<br/>RLS Enabled]
            Analyses[analyses<br/>RLS Enabled]
            Reviews[reviews<br/>RLS Enabled]
            Competitors[competitors]
        end
        
        subgraph "Invoice Tables"
            Invoices[invoices<br/>RLS Enabled]
            InvoiceItems[invoice_items]
            Transactions[inventory_transactions]
            PriceTracking[item_price_tracking]
        end
        
        subgraph "Menu Tables"
            Menus[menus<br/>RLS Enabled]
            MenuItems[menu_items]
            MenuIngredients[menu_item_ingredients]
            CompMenus[competitor_menus]
            CompMenuItems[competitor_menu_items]
            SavedComparisons[saved_menu_comparisons]
        end
        
        subgraph "Inventory Tables"
            InventoryItems[inventory_items<br/>Master Data]
            Vendors[vendors]
            Categories[categories]
            Units[units_of_measure]
        end
        
        subgraph "System Tables"
            Subscriptions[subscriptions]
            UsageLimits[usage_limits<br/>Atomic Updates]
            UserPreferences[user_preferences]
        end
        
        RLS[Row Level Security<br/>user_id Policies]
        Functions[Database Functions<br/>Fuzzy Matching<br/>Price Analytics<br/>Cascade Deletes]
    end

    subgraph "Storage Layer - Supabase"
        InvoiceBucket[Invoices Bucket<br/>Signed URLs 1hr]
        MenuBucket[Menus Bucket<br/>Signed URLs 1hr]
    end

    %% Client to Security
    Browser -->|HTTPS| CSP
    Browser -->|HTTPS| HSTS
    Browser -->|Requests| XFrame
    Browser -->|Requests| XContent
    Browser -->|Cookies| SameSite

    %% Security to Frontend
    CSP -.->|Enforces| Pages
    SameSite -.->|Protects| AuthStore

    %% Frontend Flow
    Pages --> Components
    Components --> AuthStore
    Components --> APIClient
    APIClient -->|withCredentials: true| CORS
    
    %% Optional Monitoring
    Components -.->|Optional| Monitoring

    %% Network to API
    CORS --> MainApp
    HTTPS -.->|Production| MainApp

    %% Middleware Stack
    MainApp --> SecHeaders
    SecHeaders --> CORSMid
    CORSMid --> ReqLog
    ReqLog --> GlobalEx
    GlobalEx --> AuthRoutes
    GlobalEx --> HealthCheck
    GlobalEx --> CSPReport

    %% Authentication Flow
    AuthRoutes --> AuthMid
    AuthMid --> JWTValidation
    JWTValidation --> SupabaseAuth
    SupabaseAuth --> Users

    %% Route Protection
    AuthMid -.->|Protects| TierAnalysis
    AuthMid -.->|Protects| InvoiceUpload
    AuthMid -.->|Protects| MenuUpload
    AuthMid -.->|Protects| Subscription

    %% Rate Limiting
    TierAnalysis --> RateLimitMid
    InvoiceUpload --> RateLimitMid
    MenuUpload --> RateLimitMid
    MenuCompare --> RateLimitMid
    RateLimitMid --> Redis

    %% Analysis Flow
    TierAnalysis --> AnalysisOrch
    StreamAnalysis --> AnalysisOrch
    AnalysisOrch --> FreeTierLLM
    AnalysisOrch --> EnhancedLLM
    AnalysisOrch --> PremiumLLM
    AnalysisOrch --> AnalysisStorage
    AnalysisStorage --> Analyses
    AnalysisStorage --> Reviews
    AnalysisStorage --> Competitors

    %% Invoice Flow
    InvoiceUpload --> FileValidator
    FileValidator --> MalwareScanner
    MalwareScanner --> DuplicateDetector
    DuplicateDetector --> InvoiceStorage
    InvoiceStorage --> InvoiceBucket
    
    InvoiceParse --> InvoiceParserLLM
    InvoiceParserLLM --> GoogleGemini
    InvoiceParserLLM --> FuzzyMatcher
    FuzzyMatcher --> InventoryItems
    
    InvoiceManage --> Invoices
    InvoiceManage --> InvoiceItems
    InvoiceProcess --> Transactions
    InvoiceProcess --> PriceTracking
    InvoiceProcess --> VendorMapper
    VendorMapper --> Vendors

    %% Menu Flow
    MenuUpload --> FileValidator
    FileValidator --> MenuStorage
    MenuStorage --> MenuBucket
    
    MenuParse --> MenuParserLLM
    MenuParserLLM --> GoogleGemini
    MenuParserLLM --> Menus
    MenuParserLLM --> MenuItems
    
    MenuRecipes --> MenuIngredients
    MenuRecipes --> InventoryItems
    MenuRecipes --> FuzzyMatcher
    
    MenuCompare --> MenuCompStorage
    MenuCompStorage --> CompMenus
    MenuCompStorage --> CompMenuItems
    MenuCompStorage --> SavedComparisons

    %% Price Analytics Flow
    PriceAnalytics --> PriceAnalytics
    PriceAnalytics --> PriceTracking
    PriceAnalytics --> Functions

    %% External API Calls (Backend Only)
    AnalysisOrch --> GooglePlaces
    AnalysisOrch --> SerpAPI
    AnalysisOrch --> Outscraper
    FreeTierLLM --> GoogleGemini
    EnhancedLLM --> GoogleGemini
    PremiumLLM --> GoogleGemini

    %% Security Services
    GlobalEx --> ErrorSanitizer
    InvoiceManage --> OwnershipValidator
    MenuManage --> OwnershipValidator
    OwnershipValidator --> Users

    %% Monitoring
    InvoiceParse --> InvoiceMonitor
    AnalysisOrch --> PerfProfiler
    InvoiceProcess --> EventBus

    %% Database Security
    Users --> RLS
    Invoices --> RLS
    Menus --> RLS
    Analyses --> RLS
    
    %% Styling
    classDef security fill:#ff6b6b,stroke:#c92a2a,color:#fff
    classDef frontend fill:#4dabf7,stroke:#1971c2,color:#fff
    classDef backend fill:#51cf66,stroke:#2f9e44,color:#fff
    classDef database fill:#ffd43b,stroke:#f59f00,color:#000
    classDef external fill:#e599f7,stroke:#9c36b5,color:#fff
    classDef storage fill:#ff922b,stroke:#e8590c,color:#fff
    
    class CSP,HSTS,XFrame,XContent,SameSite,SecHeaders,AuthMid,RLS,ErrorSanitizer,OwnershipValidator security
    class Browser,Pages,Components,AuthStore,APIClient,Monitoring frontend
    class MainApp,AuthRoutes,TierAnalysis,InvoiceUpload,MenuUpload,AnalysisOrch backend
    class SupabaseDB,Users,Invoices,Menus,Analyses,Redis database
    class GoogleGemini,GooglePlaces,SerpAPI,Outscraper external
    class InvoiceBucket,MenuBucket,InvoiceStorage,MenuStorage storage
