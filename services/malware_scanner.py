"""
Malware Scanner Service
Scans uploaded files using ClamAV before processing
"""
import clamd
import logging
from typing import Dict, Optional
from fastapi import UploadFile
import os

logger = logging.getLogger(__name__)


class MalwareScannerService:
    def __init__(self):
        self.enabled = os.getenv('CLAMAV_ENABLED', 'true').lower() == 'true'
        self.host = os.getenv('CLAMAV_HOST', 'localhost')
        self.port = int(os.getenv('CLAMAV_PORT', '3310'))
        self.client = None
        
        if self.enabled:
            try:
                self.client = clamd.ClamdNetworkSocket(host=self.host, port=self.port)
                # Test connection
                self.client.ping()
                logger.info(f"âœ… ClamAV connected: {self.host}:{self.port}")
            except Exception as e:
                logger.warning(f"âš ï¸ ClamAV not available: {e}. Malware scanning disabled.")
                self.enabled = False
    
    async def scan_file(self, file: UploadFile) -> Dict:
        """
        Scan uploaded file for malware
        
        Returns:
            {
                "safe": bool,
                "threat_found": Optional[str],
                "scan_performed": bool,
                "scan_time_ms": float
            }
        """
        import time
        scan_start = time.time()
        
        if not self.enabled or not self.client:
            logger.warning("âš ï¸ Malware scan skipped - ClamAV not available")
            return {
                "safe": True,
                "threat_found": None,
                "scan_performed": False,
                "scan_time_ms": 0
            }
        
        try:
            logger.info(f"ðŸ” Starting malware scan: {file.filename}")
            
            # Read file content
            file_content = await file.read()
            file_size_kb = len(file_content) / 1024
            logger.debug(f"   File size: {file_size_kb:.2f} KB")
            
            # Reset file pointer for subsequent reads
            if hasattr(file, 'file'):
                file.file.seek(0)
            
            # Scan with ClamAV - instream expects a file-like object
            from io import BytesIO
            logger.debug(f"   Sending to ClamAV: {self.host}:{self.port}")
            result = self.client.instream(BytesIO(file_content))
            
            scan_time = (time.time() - scan_start) * 1000
            logger.debug(f"   Scan completed in {scan_time:.2f}ms")
            
            # Parse result
            # Result format: {'stream': ('OK', None)} or {'stream': ('FOUND', 'Eicar-Test-Signature')}
            scan_result = result.get('stream', ('ERROR', 'Unknown'))
            status, threat = scan_result
            
            if status == 'OK':
                logger.info(f"âœ… File clean: {file.filename} ({file_size_kb:.2f} KB, {scan_time:.2f}ms)")
                return {
                    "safe": True,
                    "threat_found": None,
                    "scan_performed": True,
                    "scan_time_ms": scan_time,
                    "file_size_kb": file_size_kb
                }
            elif status == 'FOUND':
                logger.warning(f"ðŸš¨ MALWARE DETECTED: {file.filename} - {threat}")
                logger.warning(f"   File size: {file_size_kb:.2f} KB")
                logger.warning(f"   Scan time: {scan_time:.2f}ms")
                return {
                    "safe": False,
                    "threat_found": threat,
                    "scan_performed": True,
                    "scan_time_ms": scan_time,
                    "file_size_kb": file_size_kb
                }
            else:
                logger.error(f"âŒ Scan error: {status} for {file.filename}")
                # Fail-safe: reject file if scan fails
                return {
                    "safe": False,
                    "threat_found": f"Scan error: {status}",
                    "scan_performed": True,
                    "scan_time_ms": scan_time
                }
                
        except Exception as e:
            scan_time = (time.time() - scan_start) * 1000
            logger.error(f"âŒ Malware scan failed for {file.filename}: {e}")
            logger.error(f"   Scan time before failure: {scan_time:.2f}ms")
            logger.exception("Full traceback:")
            # Fail-safe: reject file if scan fails
            return {
                "safe": False,
                "threat_found": f"Scan failed: {str(e)}",
                "scan_performed": False,
                "scan_time_ms": scan_time
            }
    
    def get_status(self) -> Dict:
        """Get scanner status for health checks"""
        if not self.enabled:
            return {
                "enabled": False,
                "status": "disabled",
                "message": "ClamAV scanning is disabled"
            }
        
        try:
            if self.client:
                self.client.ping()
                version = self.client.version()
                return {
                    "enabled": True,
                    "status": "healthy",
                    "version": version,
                    "host": self.host,
                    "port": self.port
                }
        except Exception as e:
            return {
                "enabled": True,
                "status": "unhealthy",
                "error": str(e)
            }
        
        return {
            "enabled": True,
            "status": "unknown"
        }
